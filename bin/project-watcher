#!/bin/bash
# Author: Kim Silkeb√¶kken <kim.silkebaekken+github@gmail.com>
# Source: https://github.com/Lokaltog/sync

# Prepare variables
SCRIPT_DIR=`dirname $0`
BASE_DIR="$1"
VIM_DIR="${BASE_DIR}/vim"
LOCK_FILE="${BASE_DIR}/tags.lock"

# Init LiveReload
sudo gem list --local | grep -qi livereload
[[ $? -eq 1 ]] && echo 'LiveReload gem is missing!' && sudo gem install livereload rb-inotify;
(echo '[!!] Starting LiveReload...'; livereload ${BASE_DIR}) &

# Init compass
for D in ${BASE_DIR}/application/assets/source/sass/*; do
	echo "[!!] Starting Compass watcher for $D..."
	compass watch $D &
done

# Make sure $XDG_CONFIG_HOME/projectpath is correct
echo -n ${BASE_DIR} > ${XDG_CONFIG_HOME}/projectpath

# Cleanup
trap "echo '[!!] Cleaning up temporary files...'; \
	rm -f ${XDG_CONFIG_HOME}/projectpath ${VIM_DIR}/cscope.files ${LOCK_FILE}; \
	exit" SIGHUP SIGINT SIGTERM

# Watch for PHP file updates
inotifywait -mr --format '%f' -e close_write ${BASE_DIR} | while read LINE; do
	FILE_EXT="${LINE##*.}"

	# Validate file extension
	[[ -z ${FILE_EXT} ]] && continue

	# Check that no lock file exists
	[[ -e ${LOCK_FILE} ]] && continue

	# Loop through valid extensions, no reason to run the script if the 
	# changed file isn't a PHP/JS file
	VALID_EXT=
	for EXT in php; do
		[[ ${FILE_EXT} == ${EXT} ]] && VALID_EXT=true
	done
	[[ ! ${VALID_EXT} ]] && continue

	# Create lock file
	touch ${LOCK_FILE}

	# Generate ctags file
	find ${BASE_DIR} \
		     ! -wholename './.git/*' \
		-and ! -wholename './.svn/*' \
		-and ! -wholename '*logs*' \
		-and ! -wholename '*tmp*' \
		-and ! -name '*~' \
		-and ! -name '*#' \
		-name '*.php' \
		-print0 | \
		xargs -0 \
		/usr/bin/ctags \
			-f ${VIM_DIR}/tags \
			--format=2 \
			--excmd=pattern \
			--fields=+inksSazl \
			--extra=+q \
			--totals=yes \
			--sort=yes \
			--php-kinds=cidfj \
			--tag-relative=yes \
			--regex-php='/abstract\s+class\s+([^ ]+)/\1/c/' \
			--regex-php='/interface\s+([^ ]+)/\1/c/' \
			--regex-php='/(public\s+|static\s+|abstract\s+|protected\s+|private\s+)function\s+\&?\s*([^ (]+)/\2/f/'

	# Generate cscope file
	find ${BASE_DIR} \
		     ! -wholename './.git/*' \
		-and ! -wholename './.svn/*' \
		-and ! -wholename '*logs*' \
		-and ! -wholename '*tmp*' \
		-and ! -name '*~' \
		-and ! -name '*#' \
		-and   -name '*.php' \
		-print > ${VIM_DIR}/cscope.files

	/usr/bin/cscope \
		-i ${VIM_DIR}/cscope.files \
		-f ${VIM_DIR}/cscope.out \
		-b

	${SCRIPT_DIR}/project-highlight ${BASE_DIR}

	# Remove lock file
	rm ${LOCK_FILE}
done
