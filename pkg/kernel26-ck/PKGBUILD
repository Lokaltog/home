pkgbase="kernel26-ck"
pkgdesc="Linux Kernel built with Con Kolivas' patchset -ck"
pkgname="kernel26-ck"
_kernelname=-ck
_basekernel=2.6.34
pkgver=${_basekernel}
pkgrel=1
_archpatchversion=1
_patchname="patch-${pkgver}-${_archpatchversion}-ARCH"
_ckpatchversion=1
_ckpatchname="patch-${_basekernel}-ck${_ckpatchversion}"
arch=(i686 x86_64)
license=('GPL2')
groups=('base')
url="http://users.on.net/~ckolivas/kernel/"
depends=('coreutils' 'kernel26-firmware>=2.6.32' 'module-init-tools' 'mkinitcpio>=0.5.20')
install=kernel26.install
source=(
	ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$_basekernel.tar.bz2
	ftp://ftp.archlinux.org/other/kernel26/${_patchname}.bz2
	http://www.kernel.org/pub/linux/kernel/people/ck/patches/2.6/${_basekernel}/${_basekernel}-ck${_ckpatchversion}/${_ckpatchname}.bz2
	http://ck.kolivas.org/patches/bfs/autoiso-xorg.patch
	config
	kernel26.preset
	usb.patch
)

build() {
	KARCH=x86
	sed -i -re "s/^(.EXTRAVERSION).*$/\1 = /" ${_ckpatchname}
	cd ${srcdir}/linux-$_basekernel

	# Add -ARCH patches
	# See http://projects.archlinux.org/linux-2.6-ARCH.git/
	patch -Np1 -i ${srcdir}/${_patchname} || return 1
	patch -Np1 -i ${srcdir}/${_ckpatchname} || return 1
	patch -Np1 -i ${srcdir}/autoiso-xorg.patch || return 1
	patch -Np1 -i ${srcdir}/usb.patch || return 1

	cat ../config >./.config

	if [ "${_kernelname}" != "" ]; then
		sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"${_kernelname}\"|g" ./.config
	fi

	make menuconfig
	#return 1

	make -j4 bzImage || return 1

	make prepare
	_kernver="$(make kernelrelease)"

	mkdir -p ${pkgdir}/{lib,boot}

	cp System.map ${pkgdir}/boot/System.map26${_kernelname}
	cp arch/$KARCH/boot/bzImage ${pkgdir}/boot/vmlinuz26${_kernelname}

	# install fallback mkinitcpio.conf file and preset file for kernel
	install -m644 -D ${srcdir}/kernel26.preset ${pkgdir}/etc/mkinitcpio.d/${pkgname}.preset || return 1

	sed \
		-e  "s/KERNEL_NAME=.*/KERNEL_NAME=${_kernelname}/g" \
		-e  "s/KERNEL_VERSION=.*/KERNEL_VERSION=${_kernver}/g" \
		-i $startdir/kernel26.install
	sed \
		-e "s|source .*|source /etc/mkinitcpio.d/kernel26${_kernelname}.kver|g" \
		-e "s|default_image=.*|default_image=\"/boot/${pkgname}.img\"|g" \
		-e "s|fallback_image=.*|fallback_image=\"/boot/${pkgname}-fallback.img\"|g" \
		-i ${pkgdir}/etc/mkinitcpio.d/${pkgname}.preset

	echo -e "# DO NOT EDIT THIS FILE\nALL_kver='${_kernver}'" > ${pkgdir}/etc/mkinitcpio.d/${pkgname}.kver

	# remove build and source links
	rm -f ${pkgdir}/lib/modules/${_kernver}/{source,build}

	# remove the firmware
	rm -rf ${pkgdir}/lib/firmware

	# remove unneeded architectures
	rm -rf ${pkgdir}/usr/src/linux-${_kernver}/arch/{alpha,arm,arm26,avr32,blackfin,cris,frv,h8300,ia64,m32r,m68k,m68knommu,mips,microblaze,mn10300,parisc,powerpc,ppc,s390,sh,sh64,sparc,sparc64,um,v850,xtensa}
}
